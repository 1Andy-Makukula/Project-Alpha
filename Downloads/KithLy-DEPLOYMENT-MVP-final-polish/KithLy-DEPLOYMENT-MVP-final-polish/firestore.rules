rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Public can read products, Shop Owners can write
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth.token.shopOwner == true;
    }

    // Public can create orders, Only Admin/System can update status to 'paid'
    // (Note: The Webhook uses the Admin SDK, which bypasses these rules, which is correct)
    match /orders/{orderId} {
      allow create: if true;
      allow read: if request.auth != null;
      allow update: if false; // Only Cloud Functions should update status!
    }

    // Only Shop Owners can update specific fields during a scan
    // You might need a specific rule here for the 'verifyAndCollect' function
    // or move that logic to a Cloud Function (onCall) for maximum security.
  }
}